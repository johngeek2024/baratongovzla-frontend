<main class="pb-20 md:pb-0">
  <router-outlet></router-outlet>
</main>

@if (!isAdminRoute()) {

  @if(uiService.isMenuPanelOpen() || uiService.isCartPanelOpen() || uiService.isFilterSidebarOpen() || uiService.isAddressModalOpen()){
    <div (click)="uiService.closeAllPanels()" class="fixed inset-0 bg-black/60 z-[90] backdrop-blur-sm"></div>
  }

  <app-header></app-header>
  <app-footer></app-footer>
  <app-bottom-nav></app-bottom-nav>

  <app-side-panel
    title="Menú"
    position="left"
    [isOpen]="uiService.isMenuPanelOpen()"
    (close)="uiService.closeAllPanels()"
    class="z-[120]">
    <nav>
      <ul class="flex flex-col">
       <li>
          <a routerLink="/" (click)="uiService.closeAllPanels()" class="flex items-center gap-4 p-4 my-1 rounded-xl text-lg font-semibold text-text-on-dark transition-colors hover:bg-primary-accent hover:text-white">
            <i class="fas fa-home text-[1.2rem] w-[25px] text-center"></i>
            <span>Inicio</span>
          </a>
        </li>
        <li>
          <a routerLink="/products" (click)="uiService.closeAllPanels()" class="flex items-center gap-4 p-4 my-1 rounded-xl text-lg font-semibold text-text-on-dark transition-colors hover:bg-primary-accent hover:text-white">
            <i class="fas fa-box-open text-[1.2rem] w-[25px] text-center"></i>
            <span>Productos</span>
          </a>
        </li>
        <li>
          <a routerLink="/compare" (click)="uiService.closeAllPanels()" class="flex items-center gap-4 p-4 my-1 rounded-xl text-lg font-semibold text-text-on-dark transition-colors hover:bg-primary-accent hover:text-white">
            <i class="fas fa-balance-scale text-[1.2rem] w-[25px] text-center"></i>
            <span>Comparar</span>
          </a>
        </li>
        <li>
          <a routerLink="/account" (click)="uiService.closeAllPanels()" class="flex items-center gap-4 p-4 my-1 rounded-xl text-lg font-semibold text-text-on-dark transition-colors hover:bg-primary-accent hover:text-white">
            <i class="fas fa-user text-[1.2rem] w-[25px] text-center"></i>
            <span>Mi Cuenta</span>
          </a>
        </li>
        <li>
          <a routerLink="/about" (click)="uiService.closeAllPanels()" class="flex items-center gap-4 p-4 my-1 rounded-xl text-lg font-semibold text-text-on-dark transition-colors hover:bg-primary-accent hover:text-white">
            <i class="fas fa-info-circle text-[1.2rem] w-[25px] text-center"></i>
            <span>Sobre Nosotros</span>
          </a>
        </li>
      </ul>
    </nav>
  </app-side-panel>

  <app-side-panel
    title="Tu Carrito"
    position="left"
    [isOpen]="uiService.isCartPanelOpen()"
    (close)="uiService.closeAllPanels()"
    class="z-[120]">

    @if (cartService.cartCount() > 0) {
      <div class="flex flex-col h-full">
        <div class="flex-grow overflow-y-auto -mr-6 pr-6">
          @for (item of cartService.items(); track item.product.id) {
            <div class="flex gap-4 py-6 border-b border-border-color">
              <img [src]="item.product.imageUrl" [alt]="item.product.name" class="w-24 h-24 rounded-lg object-contain bg-dark-bg flex-shrink-0">
              <div class="flex-grow flex flex-col">
                <h4 class="text-text-on-dark font-semibold leading-tight">{{ item.product.name }}</h4>
                <p class="text-sm text-text-on-dark/70 capitalize">{{ item.product.category }}</p>

                <div class="flex justify-between items-center mt-auto pt-2">
                  <p class="text-primary-accent font-bold text-lg">${{ item.product.price }}</p>
                  <div class="flex items-center gap-3">
                    <button (click)="cartService.updateQuantity(item.product.id, -1)" class="w-7 h-7 rounded-full bg-border-color text-white">-</button>
                    <span class="font-bold w-5 text-center text-text-on-dark">{{ item.quantity }}</span>
                    <button (click)="cartService.updateQuantity(item.product.id, 1)" class="w-7 h-7 rounded-full bg-border-color text-white">+</button>
                  </div>
                </div>
              </div>
              <button (click)="cartService.removeFromCart(item.product.id)" class="text-text-secondary hover:text-flash-accent text-xl self-start pt-1">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          }
        </div>

        <div class="flex-shrink-0 pt-6 border-t border-border-color">
          <div class="flex justify-between text-lg text-text-on-dark">
            <span>Subtotal</span>
            <span class="font-bold">${{ cartService.totalPrice() }}</span>
          </div>

          <a routerLink="/cart" (click)="uiService.closeAllPanels()" class="block text-center w-full mt-4 bg-primary-accent text-white font-bold py-3 rounded-lg hover:bg-white hover:text-dark-bg transition-colors">
            Ir al Carrito y Pagar
          </a>
        </div>
      </div>
    } @else {
      <div class="flex flex-col items-center justify-center h-full text-center">
        <i class="fas fa-shopping-cart text-6xl text-border-color"></i>
        <p class="text-text-secondary mt-4">Tu carrito está vacío.</p>
      </div>
    }
  </app-side-panel>

  @if(uiService.isAddressModalOpen()) {
    <div (click)="uiService.closeAllPanels()" class="fixed inset-0 bg-dark-bg/90 backdrop-blur-lg z-[110] flex items-center justify-center p-4">
      <div (click)="$event.stopPropagation()" class="bg-dark-bg-secondary border border-border-color rounded-2xl p-6 w-full max-w-lg transition-all duration-300 ease-out animate-in fade-in-90 scale-95">
        <div class="flex justify-between items-center mb-6">
          <h3 class="font-headings text-2xl text-white">Gestionar Dirección</h3>
          <button (click)="uiService.closeAllPanels()" class="text-text-secondary text-3xl transition-transform hover:text-white hover:rotate-90">&times;</button>
        </div>
        <div>
          <h4 class="font-semibold text-text-on-dark mb-4">Añadir Nueva Dirección</h4>
          <form class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-text-on-dark mb-2">Dirección</label>
              <input type="text" class="w-full bg-dark-bg border border-border-color rounded-md px-3 py-2 text-text-on-dark focus:border-primary-accent focus:ring-0" placeholder="Urb, Calle, Casa/Apto">
            </div>
            <div>
              <label class="block text-sm font-medium text-text-on-dark mb-2">Ciudad</label>
              <input type="text" class="w-full bg-dark-bg border border-border-color rounded-md px-3 py-2 text-text-on-dark focus:border-primary-accent focus:ring-0" value="Valencia" placeholder="Valencia">
            </div>
            <div>
              <label class="block text-sm font-medium text-text-on-dark mb-2">Estado</label>
              <input type="text" class="w-full bg-dark-bg border border-border-color rounded-md px-3 py-2 text-text-on-dark focus:border-primary-accent focus:ring-0" value="Carabobo" placeholder="Carabobo">
            </div>
            <div class="flex justify-end gap-4 mt-6">
              <button type="button" (click)="uiService.closeAllPanels()" class="bg-border-color text-text-on-dark font-bold py-2 px-4 rounded-md hover:bg-text-secondary transition-colors">Cancelar</button>
              <button type="submit" (click)="uiService.closeAllPanels()" class="bg-primary-accent text-white font-bold py-2 px-6 rounded-md hover:bg-opacity-80 transition-colors">Guardar Dirección</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }

  <app-achievement-toast></app-achievement-toast>
  <app-cart-toast></app-cart-toast>
  <app-search-overlay></app-search-overlay>
}
