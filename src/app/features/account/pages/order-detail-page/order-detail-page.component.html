@if(order(); as currentOrder) {
<div class="container mx-auto p-4 md:p-8 max-w-7xl animate-fade-in-up">

    <header class="mb-8">
        <a routerLink="/account/orders" class="text-primary-accent hover:opacity-80 transition-opacity duration-300 mb-2 inline-block">
            <i class="fas fa-arrow-left mr-2"></i>Volver a Mis Misiones
        </a>
        <h1 class="font-headings text-4xl md:text-5xl font-bold">Misión #{{ currentOrder.id }}</h1>
        <p class="text-text-secondary text-lg">Estado Actual:
            <span class="font-semibold transition-colors duration-500" [ngClass]="{
                'text-success': status() === 'Entregado',
                'text-warning': status() !== 'Entregado'
            }">
                {{ status() }}
            </span>
        </p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 space-y-8">
            <div class="bg-dark-bg-secondary rounded-xl shadow-lg p-6">
                <h2 class="font-headings text-2xl font-bold mb-4">Progreso de la Misión</h2>
                <div class="relative pt-1">
                    <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-border-color">
                        <div [style.width]="progressWidth()" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-primary-accent transition-all duration-1000 ease-out"></div>
                    </div>
                </div>
                <div class="flex justify-between text-xs text-text-secondary">
                    @for(step of statusSteps; track step) { <span>{{ step }}</span> }
                </div>
            </div>

            <div class="bg-dark-bg-secondary rounded-xl shadow-lg p-6">
                <h2 class="font-headings text-2xl font-bold mb-4">Contenido del Paquete</h2>
                <ul class="divide-y divide-border-color">
                    @for(item of currentOrder.items; track item.product.id) {
                    <li class="flex items-center py-4">
                        <img [src]="item.product.imageUrl" [alt]="item.product.name" class="w-20 h-20 rounded-md object-cover mr-4 bg-dark-bg">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg text-text-primary">{{ item.product.name }}</h3>
                            <p class="text-sm text-text-secondary">SKU: {{ item.product.sku }}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg text-text-primary">{{ item.product.price | currency:'USD' }}</p>
                            <p class="text-sm text-text-secondary">Cant: {{ item.quantity }}</p>
                        </div>
                    </li>
                    }
                </ul>
            </div>

            <div class="bg-dark-bg-secondary rounded-xl shadow-lg p-6">
                <div class="flex items-center gap-4 mb-4">
                    <i class="fas fa-satellite-dish text-primary-accent text-xl"></i>
                    <h2 class="font-headings text-2xl font-bold">Bitácora de Misión</h2>
                </div>
                <ul class="space-y-4 font-mono text-sm">
                    @for(entry of missionLog(); track entry.time) {
                    <li class="flex items-start gap-4 animate-fade-in-up">
                        <span class="text-primary-accent pt-1"><i class="fas" [ngClass]="getIconForStatus(entry.status)"></i></span>
                        <div>
                            <p class="text-text-primary">{{ entry.status }}</p>
                            <p class="text-xs text-text-secondary">{{ entry.time | date:'yyyy-MM-dd HH:mm' }}</p>
                        </div>
                    </li>
                    } @empty {
                        <li class="text-text-secondary">Recibiendo transmisión de la bitácora...</li>
                    }
                </ul>
            </div>
        </div>

        <div class="lg:col-span-1 space-y-8">
            <div class="bg-dark-bg-secondary rounded-xl shadow-lg p-6">
                <h2 class="font-headings text-2xl font-bold mb-4">Resumen Financiero</h2>
                <div class="space-y-2 text-text-secondary">
                    <div class="flex justify-between"><span>Subtotal:</span> <span class="text-text-primary">{{ subtotal() | currency:'USD' }}</span></div>
                    <div class="flex justify-between"><span>Envío:</span> <span class="text-text-primary">$0.00</span></div>
                    <hr class="border-border-color my-2">
                    <div class="flex justify-between font-bold text-xl">
                        <span class="text-text-primary">Total:</span>
                        <span class="text-primary-accent">{{ currentOrder.total | currency:'USD' }}</span>
                    </div>
                </div>
            </div>

            <div class="bg-dark-bg-secondary rounded-xl shadow-lg p-6">
                <h2 class="font-headings text-2xl font-bold mb-4">Punto de Entrega</h2>
                <address class="not-italic text-text-secondary">
                    <strong class="text-text-primary">{{ currentOrder.shippingAddress.recipient }}</strong><br>
                    {{ currentOrder.shippingAddress.line1 }}<br>
                    {{ currentOrder.shippingAddress.city }}, {{ currentOrder.shippingAddress.state }}
                </address>
            </div>

            @if (status() === 'Entregado') {
                <div class="bg-gradient-to-br from-secondary-accent/80 to-amber-600 rounded-xl p-6 text-center text-dark-bg relative overflow-hidden animate-pulse-glow">
                    <i class="fas fa-award text-5xl text-amber-900/50 absolute -top-2 -left-2"></i>
                    <h2 class="font-headings text-2xl font-bold mb-2">¡Misión Completada!</h2>
                    <p class="mb-4">Un paquete de suministros ha llegado.</p>
                    <button (click)="openRewardModal()" class="bg-dark-bg hover:bg-black text-secondary-accent font-bold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 w-full">
                        <i class="fas fa-box-open mr-2"></i>Abrir Suministros
                    </button>
                </div>
            } @else {
                <div class="bg-dark-bg-secondary rounded-xl shadow-lg p-6">
                    <h2 class="font-headings text-2xl font-bold mb-4">Acciones Rápidas</h2>
                    <div class="space-y-3">
                        <button class="w-full text-left bg-border-color/50 hover:bg-border-color transition-colors duration-200 p-3 rounded-lg flex items-center">
                            <i class="fas fa-headset w-6 text-center mr-3 text-primary-accent"></i> Contactar Soporte
                        </button>
                    </div>
                </div>
            }
            </div>
    </main>
</div>
} @else {
<div class="text-center p-8">
    <h1 class="font-headings text-4xl text-danger">Misión No Encontrada</h1>
    <p class="text-text-secondary mt-4">No se pudieron recuperar los datos de esta misión.</p>
    <a routerLink="/account/orders" class="mt-8 inline-block bg-primary-accent text-dark-bg-text font-bold py-3 px-6 rounded-lg">
        Volver a Mis Misiones
    </a>
</div>
}


@if (isRewardModalOpen()) {
<div class="fixed inset-0 bg-dark-bg/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" [class.animate-fade-in]="rewardAnimationStep() !== 'initial'" [class.animate-fade-out]="rewardAnimationStep() === 'initial'">
    <div class="absolute inset-0" (click)="closeRewardModal()"></div>
    <button (click)="closeRewardModal()" class="absolute top-4 right-4 text-white/50 hover:text-white transition-colors z-50" [class.opacity-0]="rewardAnimationStep() !== 'reward'">
        <i class="fas fa-times text-2xl"></i>
    </button>

    @if (rewardAnimationStep() === 'crate') {
    <div class="relative w-64 h-64 animate-crate-drop">
        <div class="absolute inset-0 rounded-full bg-secondary-accent/50 animate-light-burst" style="animation-delay: 1.5s;"></div>
        <div class="relative w-full h-full flex items-center justify-center animate-crate-shake" style="animation-delay: 0.4s; animation-name: crate-shake, crate-shatter; animation-duration: 0.5s, 0.4s; animation-delay: 0.4s, 1.5s;">
            <i class="fas fa-box text-9xl text-amber-300 drop-shadow-[0_0_15px_rgba(255,215,0,0.7)]"></i>
        </div>
    </div>
    }

    @if (rewardAnimationStep() === 'reward') {
    <div class="text-center bg-dark-bg-secondary p-8 rounded-xl shadow-2xl max-w-sm relative z-10 border border-border-color animate-reward-reveal">
        <div class="relative w-16 h-16 mx-auto mb-4">
            <div class="absolute inset-0 bg-secondary-accent/20 rounded-full"></div>
            <i class="fas fa-award text-5xl text-secondary-accent relative z-10 flex items-center justify-center w-full h-full"></i>
        </div>
        <h2 class="font-headings text-3xl font-bold mb-2 text-white">¡Recompensa Adquirida!</h2>
        <p class="font-bold text-lg text-secondary-accent">¡Cupón de 15% OFF!</p>
        <p class="font-mono bg-dark-bg rounded p-2 my-4 text-secondary-accent tracking-widest cursor-pointer relative overflow-hidden coupon-shimmer-effect" (click)="copyCoupon($event)" title="Click para copiar">
            <span class="relative z-10">BARATONGO-ELITE-15</span>
        </p>
        <button class="bg-primary-accent hover:opacity-80 text-dark-bg font-bold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 w-full mt-4">
            <i class="fas fa-star mr-2"></i>Añadir a Mi Arsenal
        </button>
    </div>
    }
</div>
}
<style>
    @keyframes animate-fade-in { from { opacity: 0; } to { opacity: 1; } }
    @keyframes animate-fade-out { from { opacity: 1; } to { opacity: 0; } }
    @keyframes animate-pulse-glow { 0%, 100% { box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.2); } 50% { box-shadow: 0 0 25px 10px rgba(255, 215, 0, 0.4); } }
    .animate-pulse-glow { animation: animate-pulse-glow 2.5s infinite ease-in-out; }

    .animate-fade-in { animation: animate-fade-in 0.3s ease forwards; }
    .animate-fade-out { animation: animate-fade-out 0.3s ease forwards; }

    @keyframes crate-drop { 0% { transform: translateY(-100%) scale(0.7); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }
    .animate-crate-drop { animation: crate-drop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

    @keyframes crate-shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }
    .animate-crate-shake { animation-name: crate-shake; }

    @keyframes light-burst { 0% { transform: scale(0); opacity: 0; } 50% { opacity: 0.8; } 100% { transform: scale(3); opacity: 0; } }
    .animate-light-burst { animation: light-burst 0.4s ease-out forwards; }

    @keyframes crate-shatter { 0% { transform: scale(1) rotate(0); opacity: 1; } 100% { transform: scale(1.5) rotate(15deg); opacity: 0; } }

    @keyframes reward-reveal { 0% { opacity: 0; transform: scale(0.8) translateY(20px); } 80% { opacity: 1; transform: scale(1.05) translateY(0); } 100% { transform: scale(1); } }
    .animate-reward-reveal { animation: reward-reveal 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }

    @keyframes coupon-shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    .coupon-shimmer-effect {
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        background-size: 200% 100%;
        animation: coupon-shimmer 2s infinite linear;
    }
</style>
