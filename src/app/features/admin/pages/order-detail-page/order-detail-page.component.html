@if (isLoading()) {
  <div class="w-full text-center py-20">
    <i class="fas fa-spinner animate-spin text-4xl text-text-secondary"></i>
  </div>
} @else {
  @if (order(); as currentOrder) {
    <div class="animate-in fade-in-0 duration-500">
      <header class="grid grid-cols-1 md:grid-cols-[1fr_auto_auto_auto] items-center gap-6 bg-dark-bg-secondary border border-border-color rounded-2xl p-6 mb-8 shadow-lg">
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold m-0">Pedido <span class="text-primary-accent">{{ currentOrder.id }}</span></h1>
          <p class="text-sm text-text-secondary">Realizado el {{ currentOrder.date | date:'dd MMM, yyyy, h:mm a' }}</p>
        </div>
        <div class="text-center">
          <p class="text-xs uppercase text-text-secondary font-semibold mb-2">Estado Actual</p>
          <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold"
                [ngClass]="{
                  'bg-warning/20 text-warning': currentOrder.status === 'Procesando',
                  'bg-primary-accent/20 text-primary-accent': currentOrder.status === 'Enviado',
                  'bg-success/20 text-success': currentOrder.status === 'Entregado',
                  'bg-danger/20 text-danger': currentOrder.status === 'Cancelado'
                }">
            <span class="w-2 h-2 rounded-full" [ngClass]="{
              'bg-warning animate-pulse': currentOrder.status === 'Procesando',
              'bg-primary-accent': currentOrder.status === 'Enviado',
              'bg-success': currentOrder.status === 'Entregado',
              'bg-danger': currentOrder.status === 'Cancelado'
            }"></span>
            {{ currentOrder.status }}
          </span>
        </div>
        <div class="text-center">
          <p class="text-xs uppercase text-text-secondary font-semibold mb-2">Grand Total</p>
          <p class="text-3xl font-bold text-success">{{ totalPaid() | currency:'USD' }}</p>
        </div>
        <div class="relative">
          <button (click)="toggleActionsMenu($event)" class="actions-btn bg-dark-bg border border-border-color rounded-lg px-4 py-2 font-semibold hover:border-primary-accent transition-colors w-full">
            Acciones Rápidas <i class="fas fa-chevron-down ml-2 text-xs"></i>
          </button>
          @if(isActionsMenuOpen()) {
            <div class="absolute top-full right-0 mt-2 w-56 bg-dark-bg-tertiary border border-border-color rounded-lg shadow-2xl p-2 z-10 animate-in fade-in-0 zoom-in-95 duration-200">
              <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm text-text-secondary hover:bg-primary-accent hover:text-white"><i class="fas fa-print w-4 text-center"></i>Imprimir Factura</a>
              <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm text-text-secondary hover:bg-primary-accent hover:text-white"><i class="fab fa-whatsapp w-4 text-center"></i>Contactar Cliente</a>
              <div class="h-px bg-border-color my-1"></div>
              <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm text-danger hover:bg-danger hover:text-white"><i class="fas fa-times-circle w-4 text-center"></i>Cancelar Pedido</a>
            </div>
          }
        </div>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-6">
        <main class="space-y-6">
          <section class="bg-dark-bg-secondary border border-border-color rounded-xl p-6">
            <h3 class="text-lg font-bold text-white mt-0 mb-4">Items del Pedido ({{ currentOrder.items.length }})</h3>
            <table class="w-full">
              <thead>
                <tr class="border-b border-border-color"><th class="p-2 text-left text-sm font-semibold text-text-secondary uppercase">Producto</th><th class="p-2 text-right text-sm font-semibold text-text-secondary uppercase">Costo</th><th class="p-2 text-right text-sm font-semibold text-text-secondary uppercase">Total</th></tr>
              </thead>
              <tbody>
                @for(item of currentOrder.items; track item.productId) {
                  <tr class="border-b border-border-color/50 last:border-none">
                    <td class="p-2 py-4">
                      <div class="flex items-center gap-4">
                        <img src="https://placehold.co/100x100/0A0C1F/FFFFFF?text=P" [alt]="item.name" class="w-12 h-12 object-contain bg-dark-bg rounded-md">
                        <div>
                          <p class="font-semibold text-white">{{ item.name }}</p>
                          <p class="text-xs text-text-secondary">SKU: {{ item.productId }}</p>
                        </div>
                      </div>
                    </td>
                    <td class="p-2 text-right text-sm text-text-secondary">{{ item.quantity }} x {{ item.price | currency }}</td>
                    <td class="p-2 text-right font-semibold">{{ (item.price * item.quantity) | currency }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </section>
        </main>
        <aside class="space-y-6 lg:sticky top-8">
          <section class="bg-dark-bg-secondary border border-border-color rounded-xl">
            <div class="p-6">
              <h3 class="text-lg font-bold text-white mt-0 mb-4">Análisis Financiero</h3>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between"><span class="text-text-secondary">Subtotal</span> <span class="font-semibold">{{ subtotal() | currency }}</span></div>
                <div class="flex justify-between"><span class="text-text-secondary">Envío</span> <span class="font-semibold">{{ shippingCost() | currency }}</span></div>
                <div class="flex justify-between"><span class="text-text-secondary">Descuento (NUEVO10)</span> <span class="font-semibold text-danger">-{{ discount() | currency }}</span></div>
                <div class="flex justify-between text-base font-bold pt-2 border-t border-dashed border-border-color"><span class="text-white">Total Pagado</span> <span class="text-white">{{ totalPaid() | currency }}</span></div>
                <hr class="border-border-color border-dashed my-2">
                <div class="flex justify-between"><span class="text-text-secondary">Costo de Productos</span> <span class="font-semibold">-{{ costOfGoods() | currency }}</span></div>
                <div class="flex justify-between"><span class="text-text-secondary">Comisiones de Pago</span> <span class="font-semibold">-{{ paymentFees() | currency }}</span></div>
                <div class="flex justify-between text-base font-bold pt-2 border-t border-dashed border-border-color"><span class="text-success">Ganancia Neta</span> <span class="text-success">{{ netProfit() | currency }}</span></div>
              </div>
            </div>
          </section>

          <section class="bg-dark-bg-secondary border border-border-color rounded-xl p-6">
            <h3 class="text-lg font-bold text-white mt-0 mb-4">Cliente</h3>
            <p class="font-semibold text-white">{{ currentOrder.customerName }}</p>
            <div class="relative flex items-center gap-2">
              <span id="customer-email" class="text-text-secondary text-sm">{{ currentOrder.customerEmail }}</span>
              <button (click)="copyToClipboard('customer-email')" class="text-text-secondary hover:text-primary-accent transition-colors"><i class="far fa-copy"></i></button>
              @if(copyTooltip()?.target === 'customer-email' && copyTooltip()?.visible) {
                <div class="absolute left-full ml-2 px-2 py-1 bg-success text-white text-xs rounded-md animate-in fade-in-0 zoom-in-95">¡Copiado!</div>
              }
            </div>
            <p class="text-text-secondary text-sm mt-2 border-t border-border-color pt-2">Dirección: <strong class="text-white">{{ currentOrder.shippingAddress }}</strong></p>
          </section>
        </aside>
      </div>
    </div>
  } @else {
    <div class="bg-dark-bg-secondary border border-border-color rounded-xl p-6 text-center">
      <h2 class="text-danger">Pedido no encontrado</h2>
      <p class="text-text-secondary">El pedido que buscas no existe o fue eliminado.</p>
      <a routerLink="/admin/orders" class="bg-primary-accent text-dark-bg border-none px-6 py-2.5 rounded-lg font-bold cursor-pointer transition-all duration-200 inline-flex mt-4">Volver a Pedidos</a>
    </div>
  }
}
