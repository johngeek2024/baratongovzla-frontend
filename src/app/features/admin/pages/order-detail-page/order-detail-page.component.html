<!-- src/app/features/admin/pages/order-detail-page/order-detail-page.component.html -->
@if (order(); as orderData) {
<div class="max-w-[1400px] mx-auto p-4 md:p-8 relative z-10">
    <header class="grid grid-cols-1 md:grid-cols-[1fr_auto_auto_auto] items-center gap-6 mb-8 p-6 md:p-8 rounded-2xl border border-border-color shadow-2xl shadow-black/20" style="background: linear-gradient(135deg, var(--color-dark-surface-2), #171d33);">
        <div class="text-center md:text-left">
            <h1 class="m-0 text-2xl md:text-3xl font-bold">Pedido <span class="text-primary-accent">#{{ orderData.id }}</span></h1>
            <div class="text-text-secondary text-sm">{{ orderData.date | date:'longDate' }} a las {{ orderData.date | date:'shortTime' }}</div>
        </div>
        <div class="text-center">
            <div class="text-xs uppercase text-text-secondary mb-2">Estado Actual</div>
            <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full font-bold text-sm" [ngClass]="statusInfo().class">
                <span class="w-2 h-2 rounded-full animate-pulse" [ngClass]="{
                    'bg-warning': orderData.status === 'Procesando',
                    'bg-primary-accent': orderData.status === 'Enviado',
                    'bg-success': orderData.status === 'Entregado',
                    'bg-danger': orderData.status === 'Cancelado',
                    'animate-none': orderData.status !== 'Procesando' && orderData.status !== 'Enviado'
                }"></span>
                {{ statusInfo().text }}
            </span>
        </div>
        <div class="text-center">
            <div class="text-xs uppercase text-text-secondary mb-2">Grand Total</div>
            <div class="text-3xl font-bold text-success">{{ orderData.total | currency:'USD' }}</div>
        </div>
        <div class="relative quick-actions" [class.open]="isActionsOpen()">
            <button class="bg-dark-bg-secondary border border-border-color text-text-primary px-5 py-3 rounded-lg font-semibold cursor-pointer transition-colors w-full hover:border-primary-accent" (click)="toggleActions($event)">
                Acciones Rápidas <i class="fas fa-chevron-down ml-2 text-xs"></i>
            </button>
            <div class="actions-dropdown absolute top-full right-0 mt-2 bg-[#1F2937] border border-border-color rounded-lg w-56 z-10 p-2 shadow-2xl opacity-0 invisible transform -translate-y-2 transition-all duration-300 open:opacity-100 open:visible open:translate-y-0">
                <a href="#" class="flex items-center px-4 py-2 text-text-secondary rounded-md hover:bg-primary-accent hover:text-dark-bg"><i class="fas fa-print w-4 text-center mr-3"></i> Imprimir Factura</a>
                <a href="https://wa.me/584141234567" target="_blank" class="flex items-center px-4 py-2 text-text-secondary rounded-md hover:bg-primary-accent hover:text-dark-bg"><i class="fab fa-whatsapp w-4 text-center mr-3"></i> Contactar Cliente</a>
                <a href="#" class="flex items-center px-4 py-2 text-text-secondary rounded-md hover:bg-primary-accent hover:text-dark-bg"><i class="fas fa-undo w-4 text-center mr-3"></i> Reembolsar Pedido</a>
                <div class="h-px bg-border-color my-2"></div>
                <a href="#" class="flex items-center px-4 py-2 rounded-md text-danger hover:bg-danger hover:text-white"><i class="fas fa-times-circle w-4 text-center mr-3"></i> Cancelar Pedido</a>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-8 items-start">
        <main class="flex flex-col gap-8">

            <section class="data-card bg-dark-bg-secondary/60 border border-border-color rounded-2xl backdrop-blur-lg shadow-lg hover:shadow-primary-accent/10 hover:border-primary-accent/50 transition-all duration-300 animate-[fadeInUp_0.5s_ease-out_forwards] opacity-0" style="animation-delay: 0.1s;">
                <div class="card-header flex items-center gap-3 p-5 border-b border-border-color">
                    <i class="fas fa-stream text-primary-accent"></i>
                    <h3 class="m-0 text-lg font-bold">Línea de Tiempo del Pedido</h3>
                </div>
                <div class="card-body p-6">
                    <ul class="flex justify-between list-none p-0 relative before:content-[''] before:absolute before:top-[15px] before:left-0 before:right-0 before:h-0.5 before:bg-border-color">
                        <li class="flex-1 text-center relative">
                            <div class="step-icon w-8 h-8 rounded-full bg-dark-bg border-2 inline-flex items-center justify-center transition-all duration-300" [class.border-success]="isStepCompleted('Procesando')" [class.text-success]="isStepCompleted('Procesando')" [class.border-primary-accent]="orderData.status === 'Procesando'" [class.text-primary-accent]="orderData.status === 'Procesando'" [class.scale-110]="orderData.status === 'Procesando'" [class.shadow-neon-primary]="orderData.status === 'Procesando'"><i class="fas fa-receipt"></i></div>
                            <div class="text-xs mt-3 text-text-secondary">Procesando</div>
                        </li>
                        <li class="flex-1 text-center relative">
                            <div class="step-icon w-8 h-8 rounded-full bg-dark-bg border-2 inline-flex items-center justify-center transition-all duration-300" [class.border-success]="isStepCompleted('Enviado')" [class.text-success]="isStepCompleted('Enviado')" [class.border-primary-accent]="orderData.status === 'Enviado'" [class.text-primary-accent]="orderData.status === 'Enviado'" [class.scale-110]="orderData.status === 'Enviado'" [class.shadow-neon-primary]="orderData.status === 'Enviado'"><i class="fas fa-truck"></i></div>
                            <div class="text-xs mt-3 text-text-secondary">Enviado</div>
                        </li>
                        <li class="flex-1 text-center relative">
                            <div class="step-icon w-8 h-8 rounded-full bg-dark-bg border-2 inline-flex items-center justify-center transition-all duration-300" [class.border-success]="isStepCompleted('Entregado')" [class.text-success]="isStepCompleted('Entregado')" [class.border-primary-accent]="orderData.status === 'Entregado'" [class.text-primary-accent]="orderData.status === 'Entregado'" [class.scale-110]="orderData.status === 'Entregado'" [class.shadow-neon-primary]="orderData.status === 'Entregado'"><i class="fas fa-check-circle"></i></div>
                            <div class="text-xs mt-3 text-text-secondary">Entregado</div>
                        </li>
                         <li class="flex-1 text-center relative">
                            <div class="step-icon w-8 h-8 rounded-full bg-dark-bg border-2 inline-flex items-center justify-center transition-all duration-300" [class.border-danger]="orderData.status === 'Cancelado'" [class.text-danger]="orderData.status === 'Cancelado'"><i class="fas fa-times-circle"></i></div>
                            <div class="text-xs mt-3 text-text-secondary">Cancelado</div>
                        </li>
                    </ul>
                </div>
            </section>

            <section class="data-card bg-dark-bg-secondary/60 border border-border-color rounded-2xl backdrop-blur-lg shadow-lg hover:shadow-primary-accent/10 hover:border-primary-accent/50 transition-all duration-300 animate-[fadeInUp_0.5s_ease-out_forwards] opacity-0" style="animation-delay: 0.2s;">
                <div class="card-header flex items-center gap-3 p-5 border-b border-border-color">
                    <i class="fas fa-box-open text-primary-accent"></i>
                    <h3 class="m-0 text-lg font-bold">Artículos del Pedido ({{ orderData.items.length || 0 }})</h3>
                </div>
                <div>
                    <table class="w-full border-collapse">
                        <thead class="border-b border-border-color">
                            <tr>
                                <th class="p-3 text-left text-xs font-semibold text-text-secondary uppercase">Producto</th>
                                <th class="p-3 text-right text-xs font-semibold text-text-secondary uppercase">Costo</th>
                                <th class="p-3 text-right text-xs font-semibold text-text-secondary uppercase">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for(item of orderData.items || []; track item.productId) {
                                <tr class="border-b border-border-color last:border-b-0 transition-colors hover:bg-white/5">
                                    <td class="p-4 align-middle">
                                        <div class="flex items-center gap-4">
                                            <img src="https://placehold.co/100x100/0A0C1F/FFFFFF?text=P" [alt]="item.name" class="w-12 h-12 object-contain bg-dark-bg rounded-lg">
                                            <div>
                                                <span class="font-semibold">{{ item.name }}</span>
                                                <span class="block text-text-secondary text-xs">SKU: {{ item.productId }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="p-4 align-middle text-right">{{ item.quantity }} x {{ item.price | currency:'USD' }}</td>
                                    <td class="p-4 align-middle text-right font-semibold">{{ (item.quantity * item.price) | currency:'USD' }}</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="data-card bg-dark-bg-secondary/60 border border-border-color rounded-2xl backdrop-blur-lg shadow-lg hover:shadow-primary-accent/10 hover:border-primary-accent/50 transition-all duration-300 animate-[fadeInUp_0.5s_ease-out_forwards] opacity-0" style="animation-delay: 0.3s;">
                <div class="card-header flex items-center gap-3 p-5 border-b border-border-color">
                    <i class="fas fa-history text-primary-accent"></i>
                    <h3 class="m-0 text-lg font-bold">Registro de Actividad del Pedido</h3>
                </div>
                <div class="card-body p-6">
                    <ul class="list-none p-0">
                        <li class="flex gap-4 py-3 border-b border-border-color">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-dark-bg-secondary flex items-center justify-center text-text-secondary"><i class="fas fa-cogs"></i></div>
                            <div class="flex-grow">
                                <p class="text-sm">Estado cambiado a <strong>Procesando</strong>.</p>
                                <p class="text-xs text-text-secondary">Por <strong>AdminAura</strong> - Hoy a las 10:30 AM</p>
                            </div>
                        </li>
                        <li class="flex gap-4 py-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-dark-bg-secondary flex items-center justify-center text-text-secondary"><i class="fas fa-credit-card"></i></div>
                            <div class="flex-grow">
                                <p class="text-sm">Pago de <strong>{{ orderData.total | currency:'USD' }}</strong> confirmado.</p>
                                <p class="text-xs text-text-secondary">Por <strong>Sistema</strong> - Hoy a las 9:15 AM</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </section>
        </main>

        <aside class="sidebar-column sticky top-8 flex flex-col gap-8">
            <section class="data-card bg-dark-bg-secondary/60 border border-border-color rounded-2xl backdrop-blur-lg shadow-lg hover:shadow-primary-accent/10 hover:border-primary-accent/50 transition-all duration-300 animate-[fadeInUp_0.5s_ease-out_forwards] opacity-0" style="animation-delay: 0.4s;">
                <div class="card-header flex items-center gap-3 p-5 border-b border-border-color">
                    <i class="fas fa-user-circle text-primary-accent"></i>
                    <h3 class="m-0 text-lg font-bold">Cliente</h3>
                </div>
                <div class="card-body p-6">
                    <div class="flex justify-between items-center gap-4 mb-6">
                        <div class="flex items-center gap-4">
                            <div class="avatar w-12 h-12 rounded-full bg-primary-accent flex items-center justify-center font-bold text-xl">{{ orderData.customerName.charAt(0) }}</div>
                            <div>
                                <div class="text-lg font-bold">{{ orderData.customerName }}</div>
                                <div class="text-text-secondary text-xs">Cliente Leal - 5 Pedidos</div>
                            </div>
                        </div>
                        <a href="#" class="bg-transparent border border-border-color text-text-secondary px-3 py-2 rounded-lg text-sm transition-colors hover:border-primary-accent hover:text-primary-accent" title="Ver Perfil Completo del Cliente">
                            <i class="fas fa-user-tag"></i>
                        </a>
                    </div>
                    <dl class="data-list">
                        <dt class="font-medium text-text-secondary mb-1 text-sm">Email</dt>
                        <dd class="m-0 mb-4 text-base flex items-center gap-2 relative">
                            <span [id]="'customer-email-' + orderData.id">{{ orderData.customerEmail }}</span>
                            <i class="far fa-copy cursor-pointer text-text-secondary transition-colors hover:text-primary-accent" (click)="copyToClipboard($event, 'customer-email-' + orderData.id)"></i>
                            <div class="copy-tooltip absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-success text-white px-3 py-1 rounded-md text-xs font-semibold opacity-0 invisible transition-all duration-300">¡Copiado!</div>
                        </dd>
                        <dt class="font-medium text-text-secondary mb-1 text-sm">Teléfono</dt>
                        <dd class="m-0 text-base">0414-1234567</dd>
                    </dl>
                </div>
            </section>

            <section class="data-card bg-dark-bg-secondary/60 border border-border-color rounded-2xl backdrop-blur-lg shadow-lg hover:shadow-primary-accent/10 hover:border-primary-accent/50 transition-all duration-300 animate-[fadeInUp_0.5s_ease-out_forwards] opacity-0" style="animation-delay: 0.5s;">
                <div class="card-header flex items-center gap-3 p-5 border-b border-border-color">
                    <i class="fas fa-shipping-fast text-primary-accent"></i>
                    <h3 class="m-0 text-lg font-bold">Gestión de Envío</h3>
                </div>
                <div class="card-body p-6">
                     <dl class="data-list">
                        <dt class="font-medium text-text-secondary mb-1 text-sm">Dirección de Envío</dt>
                        <dd class="m-0 mb-4 text-base leading-snug">{{ orderData.shippingAddress }}</dd>
                    </dl>
                    <div class="mb-5">
                        <label for="tracking-number" class="block font-medium mb-2 text-sm">Añadir Número de Seguimiento</label>
                        <div class="flex">
                            <select id="shipping-carrier" class="flex-grow bg-dark-bg border border-border-color px-4 py-3 text-text-primary text-base outline-none transition-colors focus:border-primary-accent rounded-l-lg">
                                <option>MRW</option>
                                <option>Zoom</option>
                                <option>Tealca</option>
                                <option>Delivery</option>
                            </select>
                            <input type="text" id="tracking-number" placeholder="Ej: 123456789" class="flex-grow bg-dark-bg border border-border-color border-l-0 px-4 py-3 text-text-primary text-base outline-none transition-colors focus:border-primary-accent rounded-r-lg">
                        </div>
                    </div>
                    <button class="w-full bg-primary-accent border border-primary-accent text-dark-bg px-4 py-3 rounded-lg text-base font-bold cursor-pointer transition-all duration-300 ease-in-out hover:bg-transparent hover:text-primary-accent hover:-translate-y-0.5 hover:shadow-lg hover:shadow-primary-accent/20">Marcar como Enviado</button>
                </div>
            </section>

            @if(financialBreakdown(); as financials) {
                <section class="data-card bg-dark-bg-secondary/60 border border-border-color rounded-2xl backdrop-blur-lg shadow-lg hover:shadow-primary-accent/10 hover:border-primary-accent/50 transition-all duration-300 animate-[fadeInUp_0.5s_ease-out_forwards] opacity-0" style="animation-delay: 0.6s;">
                    <div class="card-header flex items-center gap-3 p-5 border-b border-border-color">
                        <i class="fas fa-wallet text-primary-accent"></i>
                        <h3 class="m-0 text-lg font-bold">Análisis Financiero</h3>
                    </div>
                    <div class="card-body p-6">
                        <div class="mb-6">
                            <div class="flex items-center gap-3 mb-4">
                                <i class="fas fa-mobile-alt text-xl text-secondary-accent"></i>
                                <h4 class="m-0 text-base font-semibold">Pago Móvil</h4>
                            </div>
                            <dl class="data-list text-sm">
                                <dt class="font-medium text-text-secondary mb-1">Referencia</dt>
                                <dd class="m-0 mb-4 flex items-center gap-2 relative">
                                    <span [id]="'ref-pago-movil-' + orderData.id">000123456789</span>
                                    <i class="far fa-copy cursor-pointer text-text-secondary transition-colors hover:text-primary-accent" (click)="copyToClipboard($event, 'ref-pago-movil-' + orderData.id)"></i>
                                    <div class="copy-tooltip absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-success text-white px-3 py-1 rounded-md text-xs font-semibold opacity-0 invisible transition-all duration-300">¡Copiado!</div>
                                </dd>
                                <dt class="font-medium text-text-secondary mb-1">Estado</dt>
                                <dd class="m-0"><span class="text-xs px-2 py-1 rounded-full font-semibold bg-success/20 text-success">Confirmado</span></dd>
                            </dl>
                        </div>
                    </div>
                    <div class="card-footer bg-black/20 p-6 border-t border-border-color">
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <span class="text-text-secondary">Subtotal</span>
                            <span class="font-semibold text-right">{{ financials.subtotal | currency:'USD' }}</span>
                            <span class="text-text-secondary">Envío</span>
                            <span class="font-semibold text-right">{{ financials.shipping | currency:'USD' }}</span>
                            <span class="text-text-secondary">Descuento <span class="text-secondary-accent italic text-xs">(NUEVO10)</span></span>
                            <span class="font-semibold text-right">{{ financials.discount | currency:'USD' }}</span>
                            <span class="text-lg font-bold">Total Pagado</span>
                            <span class="text-lg font-bold text-right">{{ financials.total | currency:'USD' }}</span>
                            <hr class="col-span-2 border-border-color border-dashed my-2">
                            <span class="text-text-secondary">Costo de Productos</span>
                            <span class="font-semibold text-right">{{ financials.productCost | currency:'USD' }}</span>
                            <span class="text-text-secondary">Comisiones de Pago</span>
                            <span class="font-semibold text-right">{{ financials.fees | currency:'USD' }}</span>
                            <span class="text-lg font-bold text-profit">Ganancia Neta</span>
                            <span class="text-lg font-bold text-right text-profit">{{ financials.netProfit | currency:'USD' }}</span>
                        </div>
                    </div>
                </section>
            }
        </aside>
    </div>
</div>
} @else {
    <div class="flex items-center justify-center h-screen">
        <div class="text-center text-text-secondary">
            <i class="fas fa-spinner fa-spin text-4xl"></i>
            <p class="mt-4">Cargando datos del comando...</p>
        </div>
    </div>
}
