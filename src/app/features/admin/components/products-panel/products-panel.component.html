<header class="flex justify-between items-center flex-wrap gap-4">
  <h1 class="text-2xl sm:text-3xl font-bold">Gestión de Productos</h1>
  <div class="flex items-center gap-4">
    <div class="flex bg-dark-bg p-1 rounded-lg border border-border-color">
      <button (click)="setViewMode('list')" class="bg-transparent border-none text-text-secondary px-3 py-1.5 rounded-md transition-all duration-200" [class.active]="viewMode() === 'list'">
        <i class="fas fa-list"></i>
      </button>
      <button (click)="setViewMode('grid')" class="bg-transparent border-none text-text-secondary px-3 py-1.5 rounded-md transition-all duration-200" [class.active]="viewMode() === 'grid'">
        <i class="fas fa-th-large"></i>
      </button>
    </div>
    <button (click)="openBulkUploadModal()" class="bg-primary-accent text-dark-bg border-none px-6 py-2.5 rounded-lg font-bold cursor-pointer transition-all duration-200 inline-flex items-center gap-2 whitespace-nowrap hover:-translate-y-0.5 hover:shadow-lg hover:shadow-primary-accent/20 hover:bg-text-secondary">
      <i class="fas fa-file-upload"></i> Carga Masiva
    </button>
    <a routerLink="/admin/products/new" class="bg-primary-accent text-dark-bg border-none px-6 py-2.5 rounded-lg font-bold cursor-pointer transition-all duration-200 inline-flex items-center gap-2 whitespace-nowrap hover:-translate-y-0.5 hover:shadow-lg hover:shadow-primary-accent/20 hover:bg-text-secondary">
      <i class="fas fa-plus"></i> Añadir Producto
    </a>
  </div>
</header>

<div class="mt-8">
  @if (viewMode() === 'list') {
    <div class="bg-dark-bg-secondary border border-border-color rounded-xl overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="border-b border-border-color">
            <th class="p-4 text-left text-sm font-semibold text-text-secondary uppercase">Imagen</th>
            <th class="p-4 text-left text-sm font-semibold text-text-secondary uppercase">Nombre</th>
            <th class="p-4 text-left text-sm font-semibold text-text-secondary uppercase">Precio</th>
            <th class="p-4 text-left text-sm font-semibold text-text-secondary uppercase">Stock</th>
            <th class="p-4 text-left text-sm font-semibold text-text-secondary uppercase">Estado</th>
            <th class="p-4 text-left text-sm font-semibold text-text-secondary uppercase">Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (product of products(); track product.id) {
            <tr class="border-b border-border-color/50 last:border-none">
              <td class="p-4 align-middle">
                <img [src]="product.imageUrl" [alt]="product.name" class="w-12 h-12 object-contain rounded-md bg-dark-bg">
              </td>
              <td class="p-4 align-middle font-semibold text-white">{{ product.name }}</td>
              <td class="p-4 align-middle">${{ product.price.toFixed(2) }}</td>
              <td class="p-4 align-middle">{{ product.stock }}</td>
              <td class="p-4 align-middle">
                <span class="px-3 py-1 rounded-full text-xs font-bold"
                      [ngClass]="{
                        'bg-success/20 text-success': product.status === 'Publicado',
                        'bg-warning/20 text-warning': product.status === 'Borrador'
                      }">
                  {{ product.status }}
                </span>
              </td>
              <td class="p-4 align-middle">
                <div class="flex items-center gap-2">
                  <a [routerLink]="['/admin/products/edit', product.id]" class="bg-transparent border-none text-text-secondary cursor-pointer text-lg p-2 rounded-md transition-colors duration-200 hover:text-primary-accent hover:bg-primary-accent/10" title="Editar Producto">
                    <i class="fas fa-edit"></i>
                  </a>
                  <button (click)="openDeleteConfirmation(product)" class="bg-transparent border-none text-text-secondary cursor-pointer text-lg p-2 rounded-md transition-colors duration-200 hover:text-danger hover:bg-danger/10" title="Eliminar Producto">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="6" class="text-center py-8 text-text-secondary">No se encontraron productos.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  } @else if (viewMode() === 'grid') {
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-6">
      @for (product of products(); track product.id) {
        <div class="bg-dark-bg-secondary border border-border-color rounded-xl overflow-hidden transition-all duration-200 flex flex-col hover:-translate-y-1 hover:shadow-2xl hover:shadow-black/30 hover:border-primary-accent">
          <div class="h-48 bg-dark-bg flex items-center justify-center p-4 relative">
            <img [src]="product.imageUrl" [alt]="product.name" class="max-h-full max-w-full object-contain">
            <span class="px-3 py-1 rounded-full text-xs font-bold absolute top-4 right-4"
                  [ngClass]="{
                    'bg-success/20 text-success': product.status === 'Publicado',
                    'bg-warning/20 text-warning': product.status === 'Borrador'
                  }">
              {{ product.status }}
            </span>
          </div>
          <div class="p-4 flex-grow">
            <h4 class="font-bold text-base text-white leading-tight">{{ product.name }}</h4>
            <p class="text-sm text-text-secondary mt-1">{{ product.sku }}</p>
          </div>
          <div class="px-4 pb-4">
            <div class="flex justify-between text-sm mb-2">
              <span class="font-bold text-white">${{ product.price.toFixed(2) }}</span>
              <span>{{ product.stock }} Unidades</span>
            </div>
            <div class="h-1.5 bg-border-color rounded-full overflow-hidden">
              <div class="h-full" [style.width.%]="product.stock > 50 ? 100 : product.stock * 2" [class.bg-success]="product.stock > 10" [class.bg-warning]="product.stock <= 10 && product.stock > 0" [class.bg-danger]="product.stock === 0"></div>
            </div>
          </div>
          <div class="flex gap-2 p-3 border-t border-border-color bg-dark-bg/50">
            <a [routerLink]="['/admin/products/edit', product.id]" class="bg-border-color text-text-primary px-6 py-2.5 rounded-lg font-bold cursor-pointer transition-all duration-200 inline-flex items-center gap-2 whitespace-nowrap hover:bg-text-secondary flex-grow justify-center">
              <i class="fas fa-edit"></i> Editar
            </a>
            <button class="bg-danger/20 text-danger px-6 py-2.5 rounded-lg font-bold cursor-pointer transition-all duration-200 inline-flex items-center gap-2 whitespace-nowrap hover:!bg-danger/40" (click)="openDeleteConfirmation(product)">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      } @empty {
        <p class="text-center py-8 text-text-secondary">No se encontraron productos.</p>
      }
    </div>
  }
</div>

<app-modal [isOpen]="isDeleteModalOpen" title="Confirmar Eliminación" (close)="closeDeleteConfirmation()">
  <p class="text-text-secondary">
    ¿Estás seguro de que deseas eliminar el producto
    <strong class="text-white">{{ productToDelete()?.name }}</strong>?
    Esta acción no se puede deshacer.
  </p>
  <div modal-footer class="flex justify-end gap-4">
    <button class="bg-border-color text-text-primary px-6 py-2.5 rounded-lg font-bold cursor-pointer transition-all duration-200 inline-flex items-center gap-2 whitespace-nowrap hover:bg-text-secondary" (click)="closeDeleteConfirmation()">Cancelar</button>
    <button class="!bg-danger !text-white px-6 py-2.5 rounded-lg font-bold cursor-pointer transition-all duration-200 inline-flex items-center gap-2 whitespace-nowrap" (click)="handleDeleteProduct()" [disabled]="isSaving()">
      @if (isSaving()) {
        <i class="fas fa-spinner animate-spin mr-2"></i>
        <span>Eliminando...</span>
      } @else {
        <span>Sí, Eliminar</span>
      }
    </button>
  </div>
</app-modal>

<app-modal [isOpen]="isBulkUploadModalOpen" title="Carga Masiva de Productos" (close)="isBulkUploadModalOpen.set(false)">
  <div class="space-y-6">
    <p class="text-text-secondary">
      Sube un archivo en formato CSV para añadir múltiples productos a tu inventario.
      El sistema ignorará automáticamente cualquier producto con un SKU o Nombre que ya exista.
    </p>
    <div class="bg-dark-bg border border-border-color rounded-lg p-4 flex items-center justify-between">
      <span class="font-semibold">Plantilla de Carga</span>
      <button (click)="downloadTemplate()" class="bg-border-color text-text-primary px-6 py-2.5 rounded-lg font-bold cursor-pointer transition-all duration-200 inline-flex items-center gap-2 whitespace-nowrap hover:bg-text-secondary !text-sm">
        <i class="fas fa-download"></i> Descargar CSV
      </button>
    </div>
    <div>
      <label for="csv-upload" class="bg-primary-accent text-dark-bg border-none px-6 py-2.5 rounded-lg font-bold cursor-pointer transition-all duration-200 inline-flex items-center gap-2 whitespace-nowrap hover:-translate-y-0.5 hover:shadow-lg hover:shadow-primary-accent/20 w-full justify-center">
        @if(isProcessingFile()) {
          <i class="fas fa-spinner animate-spin"></i>
          <span>Procesando...</span>
        } @else {
          <i class="fas fa-upload"></i>
          <span>Seleccionar Archivo CSV</span>
        }
      </label>
      <input type="file" id="csv-upload" class="hidden" accept=".csv" (change)="handleFileUpload($event)">
    </div>

    @if(uploadFeedback(); as feedback) {
      <div class="border rounded-lg p-4" [ngClass]="{'border-success/50': feedback.errorCount === 0, 'border-danger/50': feedback.errorCount > 0}">
        <h4 class="font-bold mb-2" [ngClass]="{'text-success': feedback.errorCount === 0, 'text-danger': feedback.errorCount > 0}">
          Proceso Completado
        </h4>
        <p class="text-sm text-text-primary">
          <span class="text-success">{{ feedback.successCount }}</span> productos añadidos.
          <span class="text-danger">{{ feedback.errorCount }}</span> filas con errores.
        </p>
        @if(feedback.errors.length > 0) {
          <ul class="text-xs text-text-secondary list-disc pl-5 mt-2 max-h-24 overflow-y-auto">
            @for(error of feedback.errors; track $index) {
              <li>{{ error }}</li>
            }
          </ul>
        }
      </div>
    }
  </div>
  <div modal-footer class="flex justify-end gap-4">
    <button class="bg-border-color text-text-primary px-6 py-2.5 rounded-lg font-bold cursor-pointer transition-all duration-200 inline-flex items-center gap-2 whitespace-nowrap hover:bg-text-secondary" (click)="isBulkUploadModalOpen.set(false)">Cerrar</button>
  </div>
</app-modal>
